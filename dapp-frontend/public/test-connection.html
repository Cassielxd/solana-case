<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Phantom è¿æ¥æµ‹è¯•</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 800px;
      margin: 50px auto;
      padding: 20px;
      background: #f5f5f5;
    }
    .container {
      background: white;
      padding: 30px;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    button {
      background: #512da8;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 16px;
      margin: 10px 5px;
    }
    button:hover {
      background: #4527a0;
    }
    button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    .status {
      margin: 20px 0;
      padding: 15px;
      border-radius: 6px;
      background: #e3f2fd;
    }
    .error {
      background: #ffebee;
      color: #c62828;
    }
    .success {
      background: #e8f5e9;
      color: #2e7d32;
    }
    pre {
      background: #263238;
      color: #aed581;
      padding: 15px;
      border-radius: 6px;
      overflow-x: auto;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸ”Œ Phantom é’±åŒ…è¿æ¥æµ‹è¯•</h1>

    <div id="status" class="status">
      ç­‰å¾…æ“ä½œ...
    </div>

    <div>
      <button onclick="checkPhantom()">1. æ£€æŸ¥ Phantom æ˜¯å¦å®‰è£…</button>
      <button onclick="connectWallet()">2. è¿æ¥é’±åŒ…</button>
      <button onclick="getBalance()">3. è·å–ä½™é¢</button>
      <button onclick="testRPC()">4. æµ‹è¯•æœ¬åœ° RPC</button>
    </div>

    <div id="details" style="margin-top: 20px;"></div>
  </div>

  <script src="https://unpkg.com/@solana/web3.js@latest/lib/index.iife.min.js"></script>
  <script>
    const statusDiv = document.getElementById('status');
    const detailsDiv = document.getElementById('details');
    let provider = null;
    let publicKey = null;

    function updateStatus(message, type = 'info') {
      statusDiv.className = 'status';
      if (type === 'error') statusDiv.classList.add('error');
      if (type === 'success') statusDiv.classList.add('success');
      statusDiv.innerHTML = message;
    }

    function showDetails(data) {
      detailsDiv.innerHTML = '<pre>' + JSON.stringify(data, null, 2) + '</pre>';
    }

    async function checkPhantom() {
      updateStatus('æ£€æŸ¥ Phantom é’±åŒ…...');

      if (window.solana && window.solana.isPhantom) {
        provider = window.solana;
        const info = {
          installed: true,
          version: window.solana._version || 'unknown',
          publicKey: window.solana.publicKey ? window.solana.publicKey.toString() : null,
          connected: window.solana.isConnected
        };
        updateStatus('âœ… Phantom é’±åŒ…å·²å®‰è£…', 'success');
        showDetails(info);
      } else {
        updateStatus('âŒ æœªæ£€æµ‹åˆ° Phantom é’±åŒ…ï¼Œè¯·å…ˆå®‰è£…', 'error');
        detailsDiv.innerHTML = '<p>è¯·è®¿é—®: <a href="https://phantom.app" target="_blank">https://phantom.app</a></p>';
      }
    }

    async function connectWallet() {
      if (!window.solana) {
        updateStatus('âŒ è¯·å…ˆå®‰è£… Phantom é’±åŒ…', 'error');
        return;
      }

      updateStatus('æ­£åœ¨è¿æ¥é’±åŒ…...');

      try {
        const resp = await window.solana.connect();
        publicKey = resp.publicKey;

        const info = {
          success: true,
          publicKey: publicKey.toString(),
          connected: window.solana.isConnected
        };

        updateStatus('âœ… é’±åŒ…è¿æ¥æˆåŠŸï¼', 'success');
        showDetails(info);
      } catch (error) {
        updateStatus('âŒ è¿æ¥å¤±è´¥: ' + error.message, 'error');
        showDetails({
          error: error.message,
          stack: error.stack,
          suggestion: 'è¯·å°è¯•ï¼š\n1. åœ¨ Phantom ä¸­åˆ‡æ¢åˆ° Devnet\n2. åˆ·æ–°é¡µé¢\n3. é‡æ–°è¿æ¥'
        });
      }
    }

    async function getBalance() {
      if (!publicKey) {
        updateStatus('âŒ è¯·å…ˆè¿æ¥é’±åŒ…', 'error');
        return;
      }

      updateStatus('æ­£åœ¨è·å–ä½™é¢...');

      try {
        const connection = new solanaWeb3.Connection('http://127.0.0.1:8899', 'confirmed');
        const balance = await connection.getBalance(publicKey);
        const sol = balance / solanaWeb3.LAMPORTS_PER_SOL;

        const info = {
          publicKey: publicKey.toString(),
          balance: sol + ' SOL',
          lamports: balance,
          rpcUrl: 'http://127.0.0.1:8899'
        };

        updateStatus(`âœ… ä½™é¢: ${sol} SOL`, 'success');
        showDetails(info);

        if (sol < 0.01) {
          detailsDiv.innerHTML += '<p style="color: #ff6f00; margin-top: 10px;">âš ï¸ ä½™é¢ä¸è¶³ï¼Œè¯·æ‰§è¡Œç©ºæŠ•å‘½ä»¤ï¼š</p><pre>solana airdrop 10 ' + publicKey.toString() + '</pre>';
        }
      } catch (error) {
        updateStatus('âŒ è·å–ä½™é¢å¤±è´¥: ' + error.message, 'error');
        showDetails({
          error: error.message,
          suggestion: 'è¯·ç¡®è®¤æœ¬åœ°éªŒè¯å™¨æ­£åœ¨è¿è¡Œï¼š\nsolana cluster-version'
        });
      }
    }

    async function testRPC() {
      updateStatus('æ­£åœ¨æµ‹è¯•æœ¬åœ° RPC...');

      try {
        const connection = new solanaWeb3.Connection('http://127.0.0.1:8899', 'confirmed');
        const version = await connection.getVersion();
        const slot = await connection.getSlot();
        const blockHeight = await connection.getBlockHeight();

        const info = {
          rpcUrl: 'http://127.0.0.1:8899',
          version: version,
          currentSlot: slot,
          blockHeight: blockHeight,
          status: 'connected'
        };

        updateStatus('âœ… æœ¬åœ° RPC è¿æ¥æ­£å¸¸', 'success');
        showDetails(info);
      } catch (error) {
        updateStatus('âŒ RPC è¿æ¥å¤±è´¥: ' + error.message, 'error');
        showDetails({
          error: error.message,
          suggestion: 'è¯·ç¡®è®¤æœ¬åœ°éªŒè¯å™¨æ­£åœ¨è¿è¡Œï¼š\nsolana-test-validator'
        });
      }
    }

    // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æ£€æŸ¥
    window.addEventListener('load', () => {
      setTimeout(checkPhantom, 500);
    });
  </script>
</body>
</html>
